AWSTemplateFormatVersion: "2010-09-09"
Description: "Terraform backend: S3 bucket for state management"

Parameters:
  ProjectName:
    Type: String
    Description: Project name used for resource naming
    Default: aws-oidc-terraform-demo

  Environment:
    Type: String
    Description: Environment name
    Default: development
    AllowedValues:
      - development
      - staging
      - prod

Resources:
  TerraformStateBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        "Fn::Sub": "${ProjectName}-tf-statefile-${Environment}"

      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced

      VersioningConfiguration:
        Status: Enabled

      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

      LifecycleConfiguration:
        Rules:
          - Id: DeleteOldVersions
            Status: Enabled
            NoncurrentVersionExpiration:
              NoncurrentDays: 90
              NewerNoncurrentVersions: 20

      LoggingConfiguration:
        DestinationBucketName:
          Ref: TerraformLogBucket
        LogFilePrefix: "access-logs/"

      Tags:
        - Key: Name
          Value:
            "Fn::Sub": "${ProjectName}-tf-statefile-${Environment}"
        - Key: Environment
          Value:
            Ref: Environment
        - Key: ManagedBy
          Value: CloudFormation
        - Key: Purpose
          Value: TerraformBackend

  # S3 Bucket for Storing Access Logs
  TerraformLogBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        "Fn::Sub": "${ProjectName}-tf-access-logs-${Environment}"

      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerEnforced

      VersioningConfiguration:
        Status: Enabled

      LifecycleConfiguration:
        Rules:
          - Id: ExpireOldLogs
            Status: Enabled
            ExpirationInDays: 90

      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256

      Tags:
        - Key: Name
          Value:
            "Fn::Sub": "${ProjectName}-tf-access-logs-${Environment}"
        - Key: Purpose
          Value: TerraformBackendAccessLogs

  TerraformStateBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: TerraformStateBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: EnforceSSL
            Action: s3:*
            Effect: "Deny"
            Principal: "*"
            Resource:
              - "Fn::Sub": "arn:${AWS::Partition}:s3:::${TerraformStateBucket}/*"
              - "Fn::Sub": "arn:${AWS::Partition}:s3:::${TerraformStateBucket}"
            Condition:
              Bool:
                aws:SecureTransport: false

  # Terraform statefile logging bucket policy to allow S3 to write logs
  LogAccessBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: TerraformLogBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: S3ServerAccessLogsPolicy
            Effect: Allow
            Principal:
              Service: logging.s3.amazonaws.com
            Action:
              - s3:PutObject
            Resource:
              "Fn::Sub": "arn:${AWS::Partition}:s3:::${TerraformLogBucket}/access-logs/*"
            Condition:
              ArnLike:
                aws:SourceArn:
                  "Fn::Sub": "arn:${AWS::Partition}:s3:::${TerraformStateBucket}"
              StringEquals:
                aws:SourceAccount:
                  Ref: "AWS::AccountId"

          - Sid: EnforceSSL
            Action: s3:*
            Effect: "Deny"
            Principal: "*"
            Resource:
              - "Fn::Sub": "arn:${AWS::Partition}:s3:::${TerraformLogBucket}/*"
              - "Fn::Sub": "arn:${AWS::Partition}:s3:::${TerraformLogBucket}"
            Condition:
              Bool:
                aws:SecureTransport: false

Outputs:
  TerraformStateBucketName:
    Description: S3 bucket name for Terraform state
    Value:
      Ref: TerraformStateBucket
    Export:
      Name:
        "Fn::Sub": "${AWS::StackName}-TerraformStateBucketName"
