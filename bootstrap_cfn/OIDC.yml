AWSTemplateFormatVersion: "2010-09-09"

Description: "OIDC Provider and IAM Role for GitHub Actions to access AWS resources"

Parameters:
  GitHubOrg:
    Description: GitHub Organization name
    Type: String
    Default: Barry-dE

  GitHubRepo:
    Description: GitHub Repository name
    Type: String
    Default: OIDC-Terraform-GitHub-Actions

  ProjectName:
    Description: Project Name
    Type: String
    Default: oidc-terraform-github-actions-demo

  Environment:
    Description: Deployment Environment name
    Type: String
    Default: production
    AllowedValues:
      - development
      - staging
      - production

  BackendStackName:
    Description: Name of the CloudFormation stack that created the Terraform backend
    Type: String
    Default: terraform-backend

Resources:
  GitHubActionsOIDCProvider:
    Type: AWS::IAM::OIDCProvider
    Properties:
      ClientIdList:
        - sts.amazonaws.com
      ThumbprintList:
        - dd55b4520291e276588f0dd02fafd83a7368e0fa
        - 6938fd4d98bab03faadb97b34396831e3780aea1
      Url: https://token.actions.githubusercontent.com
      Tags:
        - Key: Name
          Value:
            "Fn::Sub": "${ProjectName}-oidc-provider-${Environment}"

  #-------------------------------------------------------------------------
  # TERRAFORM PLAN ROLE
  #-------------------------------------------------------------------------
  TerraformPlanRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName:
        "Fn::Sub": "${ProjectName}-terraform-plan-role-${Environment}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Federated: !Ref GitHubActionsOIDCProvider
            Action: "sts:AssumeRoleWithWebIdentity"
            Condition:
              StringEquals:
                token.actions.githubusercontent.com:aud: sts.amazonaws.com
              StringLike:
                token.actions.githubusercontent.com:sub:
                  "Fn::Sub": "repo:${GitHubOrg}/${GitHubRepo}:ref:refs/pull/*"
      Description: Role for Terraform Plan
      MaxSessionDuration: 3600
      Path: /terraform/github-actions/
      Policies:
        - PolicyName: TerraformPlanAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Sid: TerraformStateBucketAccess
                Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:GetBucketVersioning
                Resource:
                  - !Sub
                    - "arn:${AWS::Partition}:s3:::${S3Bucket}"
                    - S3Bucket: !ImportValue
                        Fn::Sub: "${BackendStackName}-TerraformStateBucketName"

              - Sid: TerraformStateRead
                Effect: Allow
                Action:
                  - s3:GetObject
                Resource:
                  - !Sub
                    - "arn:${AWS::Partition}:s3:::${S3Bucket}/terraform.tfstate"
                    - S3Bucket: !ImportValue
                        Fn::Sub: "${BackendStackName}-TerraformStateBucketName"

              - Sid: TerraformStateLockAccess
                Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource:
                  - !Sub
                    - "arn:${AWS::Partition}:s3:::${S3Bucket}/*.tflock"
                    - S3Bucket: !ImportValue
                        Fn::Sub: "${BackendStackName}-TerraformStateBucketName"

              - Sid: VPCResourceReadAccess
                Effect: Allow
                Action:
                  - ec2:Describe*
                Resource: "*"

              - Sid: CloudWatchLogsReadAccess
                Effect: Allow
                Action:
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                  - logs:ListTagsLogGroup
                Resource: "*"

              - Sid: IAMReadAccess
                Effect: Allow
                Action:
                  - iam:GetRole
                  - iam:GetRolePolicy
                  - iam:ListAttachedRolePolicies
                  - iam:ListRolePolicies
                  - iam:GetPolicyVersion
                  - iam:GetPolicy
                  - iam:ListPolicyVersions
                Resource: "*"

      Tags:
        - Key: Name
          Value: !Sub "${ProjectName}-terraform-plan-role-${Environment}"
        - Key: Type
          Value: github-actions-terraform-role

Outputs:
  TerraformPlanRoleArn:
    Description: ARN of the Terraform Plan IAM Role
    Value: !GetAtt TerraformPlanRole.Arn
    Export:
      Name: !Sub "${AWS::StackName}-PlanRoleArn"

  OIDCProviderArn:
    Description: ARN of the GitHub Actions OIDC Provider
    Value: !GetAtt GitHubActionsOIDCProvider.Arn
    Export:
      Name: !Sub "${AWS::StackName}-OIDCProviderArn"
